# PEP-11: AWS S3 Plan for EDI Data Resources

- Author(s): Mark Servilla
- Contact: mark.servilla@gmail.com
- Status: Draft
- Type: Process
- Created: 2024-12-08
- Reviewed:
- Final:


## Introduction

The PASTA software stack currently uses block storage for all data resources published to the Environmental Data Initiative (EDI) data repository. EDI is migrating PASTA services (virtual machines, system storage, and data storage) to Amazon Web Services (AWS). As part of this move, EDI plans to utilize AWS's Simple Storage Service (S3) for all published data resources. The following proposal outlines the organization and storage classification of data resources using objects within S3 buckets.

## Issue Statement

The EDI data repository uses a network-attached block storage device as its active data store. PASTA’s Java code utilizes the `java.nio` library, a low-level interface for performing I/O with POSIX-compliant file systems, to read and write data files on the block storage device. These data files comprise the data resources of PASTA data packages, including the science data, metadata, and the package's quality report. The set of data resources for a given data package is written into a directory on the block storage device using the “scope.identifier.revision” convention of the data package identifier (e.g., `knb-lter-nin.2.1`) for the directory’s name. There are five or more data resources found in each data package directory. These include:

1. The original science metadata in the Ecological Metadata Language (EML) format submitted by the author: `Level-0-EML.xml`;
2. A revised version of the science metadata generated by PASTA and containing EDI specific content: `Level-1-EML.xml`;
3. A version of the metadata in the Dublin Core format: `Level-1-DC.xml`;
4. The PASTA EML congruency checker quality report: `quality_report.xml`; and 
5. One or more science data files with "hash-values" for names (e.g., `673770d3d0507bc0c2cac3eaccd71e70`).

In some cases, when the same science data are repeated in multiple revisions of a data package, the Java code “hard-links” the science data files so that the logical replicas of the data use the same physical file on the block storage device, reducing the overall storage space required by the science data. This space-saving feature of PASTA is only possible to POSIX-compliant file systems.

For reasons beyond the scope of this proposal, EDI is migrating its services, including all data resources, to AWS: data resources will be moved from the block storage device at the University of New Mexico to AWS and will be stored in S3 as objects within buckets. The benefits of using S3 object storage over block storage are the following:

1. S3 storage does not have to be attached to a host system for it to be utilized;
2. S3 objects are accessed through the HTTP protocol;
3. S3 objects can be accessed concurrently by multiple clients;
4. S3 storage capacity scales on demand; and 
5. S3 storage is a "pay-for-only-what-you-use" cost model.

This proposal presents an approach for organizing data resources in S3, including strategies for initial loading of data resources and how the PASTA software stack will interact with S3.

## Proposed Solution

### Bucket Organization

We propose to replace the hierarchical structure of the current EDI data resource block storage organization with a similar structure within multiple AWS S3 buckets. Buckets are logical containers for data objects residing in AWS S3 and are analogous to a mounted file system in modern desktop or server computers. In general, buckets have few constraints (see [working with buckets](https://docs.aws.amazon.com/AmazonS3/latest/userguide/creating-buckets-s3.html)) and support the concept of folders (i.e., directories), which can be nested within other folders, providing the same hierarchical layering available in a block storage device.

We plan to organize buckets around EDI services, naming them with some element of the service being represented. Because buckets names must be unique across all of AWS (see [bucket name rules](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html) for more information), we will use a combination of the EDI service name prefixed to a UUID, creating unique EDI bucket names. For example, EDI maintains three separate physical tiers of the PASTA software, one each for development, staging, and production uses, respectively. Corresponding buckets names would be:

1. `edi-pasta-development-0c8c25f7-82f9-4350-99d8-9cd4579c8b92`
2. `edi-pasta-staging-28a0a25b-33d0-4560-afb2-abd6745aae67`
3. `edi-pasta-production-bb417e09-4b3f-46be-8138-f5f83da77493`

Similarly, we can create a bucket named `edi-ezeml-307e0697-c244-4730-904b-4bacd92fc2eb` for "ezEML" storage needs.

### Object Organization in an "edi-pasta" Bucket

As mentioned above, S3 buckets support the "notion" of hierarchical folders where slashes in an object name are inferred to denote a hierarchical structure. The slash notation, however, does not create physical folders (i.e., directories) in the bucket; instead, the forward slash character "`/`" only creates the visual representation of a folder in the S3 object "key" name (see below). We plan to use this feature to replicate the directory structure within the existing block storage devices used by PASTA's *Data Package Manager* service (see above in *Issue Statement*) to organize data packages and related data resources in S3 buckets. This means that within each S3 bucket, a "logical" data package folder will be created with its package identifier as the folder name. The data resources will then be added to this folder by prepending the folder name to the resource's object "key" name. This will result in the following perceived structure:

```
knb-lter-nin.2.1
├── 673770d3d0507bc0c2cac3eaccd71e70
├── Level-0-EML.xml
├── Level-1-DC.xml
├── Level-1-EML.xml
└── quality_report.xml
```
along with the actual data resource object "key" names:

```
knb-lter-nin.2.1/673770d3d0507bc0c2cac3eaccd71e70
knb-lter-nin.2.1/Level-0-EML.xml
knb-lter-nin.2.1/Level-1-DC.xml
knb-lter-nin.2.1/Level-1-EML.xml
knb-lter-nin.2.1/quality_report.xml
```

### Object Storage Classification

### Bucket and Object Access

To facilitate the use of existing code-bases, we plan to use a [FUSE file system](https://en.wikipedia.org/wiki/Filesystem_in_Userspace), "[AWS Mountpoint](https://docs.aws.amazon.com/AmazonS3/latest/userguide/mountpoint.html)", that will provide similar, but not complete, use of POSIX-style commands. 

## Open issue(s)

...

## References

...

## Rejection

...
